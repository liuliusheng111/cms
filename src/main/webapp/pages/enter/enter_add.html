<!DOCTYPE html>
<html>
<head lang="zh-CN">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>投稿</title>
    <meta name="keywords" content="投稿"/>
    <meta name="description" content="投稿"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <meta name="format-detection" content="telephone=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="icon" href="${BASE_PATH }favicon.ico" />
    <link rel="stylesheet" href="${BASE_PATH}/static/enter/css/common/base_rem.css?ver=0421"/>
    <link rel="stylesheet" href="${BASE_PATH}/static/enter/css/app/enter.css?var=0421"/>
    <!-- 验证工具 -->
    <script>
        var deviceWidth = document.documentElement.clientWidth;
        if (deviceWidth > 540) deviceWidth = 540;
        document.documentElement.style.fontSize = deviceWidth / 7.5 + 'px';
    </script>
</head>
<body>
<div class="main">
    <div class="fillinfo">
        <div style="text-align: center">
            <img src="${BASE_PATH}/static/template/ybsf/logo.png" />
        </div>

        <div class="" style="padding-top: 10px;text-align: center;font-size: 18px">
            <span>投稿</span>
        </div>
        <!--
        <div class="fillinfo_title">
            <span>投稿</span>
        </div>
        -->
        <div class="fillbox">
            <form name="form" id="form1" action="enter/add" method="post" enctype="multipart/form-data">
                <input type="hidden" name="model.id" value="${model.id}" />
                <div class="field name">
                    <p class="fn-clear"><label>参赛者姓名</label>
                        <input type="text" placeholder="(必填)" valid="vtext" name="model.name"/>
                    </p>
                </div>
                <div class="type fn-clear">
                    <div class="radio_l" style="">参赛者性别</div>
                    <div class="radio_r">
                        <span>
                           <label for="male">男</label>
                           <input type="radio" checked id="male" name="model.gender" value="1"/>
                        </span>
                        <span>
                           <label for="semale">女</label>
                           <input type="radio" id="semale" name="model.gender" value="0"/>
                        </span>
                    </div>
                </div>

                <div class="field declaration">
                    <p class="fn-clear"><label>参赛者年龄</label>
                        <input type="text" placeholder="(选填)" name="model.age"/>
                    </p>
                </div>

                <div class="photo fn-clear">
                    <div class="photo_l"><label>参赛者作品</label></div>
                    <div class="photo_r">
                        <span class="addimg">
                            <input type="file" id="file1"  accept="image/*" onchange="uploadFile(1)" name="file1"/>
                            <input type="hidden" id="imageId1" name="imageId1">
                            <img  id="img1" class="addedimg"  style="display: none">
                            <img  id="del1" class="del" src="static/enter/images/del.png" style="display: none" onclick="removeImg(1)">
                        </span>
                        <span class="addimg">
                            <input type="file"  id="file2" accept="image/*" onchange="uploadFile(2)" name="file2"/>
                            <input type="hidden" id="imageId2" name="imageId2">
                            <img id="img2" class="addedimg"  style="display:none">
                            <img id="del2" class="del" src="static/enter/images/del.png" style="display: none" onclick="removeImg(2)">

                        </span>
                        <!--
                        <span class="addimg">
                            <input type="file"  id="file3" accept="image/*" onchange="uploadFile(3)" name="file3"/>
                            <input type="hidden" id="imageId3" name="imageId3">
                            <img  id="img3" class="addedimg"  style="display:none">
                            <img class="del" id="del3" src="static/enter/images/del.png" style="display: none" onclick="removeImg(3)">
                        </span>
                        -->

                    </div>
                </div>
                <div class="field phone">
                    <p class="fn-clear"><label>手机号码</label>
                        <input type="text" placeholder="(必填,本人或监护人手机号)" name="model.phone"/>
                    </p>
                </div>
                <div class="field declaration">
                    <p class="fn-clear"><label>参赛者地址</label>
                        <input type="text" placeholder="(必填,请详细填写,便于寄送资料)" name="model.address"/>
                    </p>
                </div>

                <div class="tojoin">
                    <input type="button" onclick="oper_save()" value="确认报名"/>
                </div>
            </form>
        </div>
    </div>
</div>
<script>

    /**
     * 上传图片,文件
     */
    function uploadFile(index) {
        var data = new FormData();
        var img ,fileObj,del,imageId;
        if(index==1){
            data.append('file', $('#file1')[0].files[0]);
            fileObj = $('#file1');
            img = $('#img1');
            del = $('#del1');
            imageId = $('#imageId1');
        }else if (index==2){
            data.append('file', $('#file2')[0].files[0]);
            fileObj = $('#file2');
            img = $('#img2');
            del = $('#del2');
            imageId = $('#imageId2');
        }else if(index==3){
            data.append('file', $('#file3')[0].files[0]);
            fileObj = $('#file3');
            img = $('#img3');
            del = $('#del3');
            imageId = $('#imageId3');
        }
        $.ajax({
            url: 'enter/uploadFile',
            type: 'POST',
            data: data,
            processData: false,  // 告诉jQuery不要去处理发送的数据
            contentType: false  // 告诉jQuery不要去设置Content-Type请求头
        }).done(function(data){
            if (data.status==1) {
                fileObj.hide();
                img.attr('src',data.url);
                img.show();
                del.show();
                imageId.val(data.name);
            }else{
                alert('保存失败！');
            }
        });
        return false;
    }

    /**
     * 移除图片ID值
     */
    function removeImg(index) {
        var img ,fileObj,del,imageId;
        if(index==1){
            fileObj = $('#file1');
            img = $('#img1');
            del = $('#del1');
            imageId = $('#imageId1');
        }else if (index==2){
            fileObj = $('#file2');
            img = $('#img2');
            del = $('#del2');
            imageId = $('#imageId2');
        }else if(index==3){
            fileObj = $('#file3');
            img = $('#img3');
            del = $('#del3');
            imageId = $('#imageId3');
        }
        fileObj.show();
        fileObj.val('');
        fileObj.empty();
        del.hide();
        img.hide();
        imageId.val("");
    }

    /**
     * 表单提交
     * @returns {boolean}
     */
    function oper_save() {
        if(!validThisForm()) {
            return false;
        }
        jQuery.ajax({
            type:'POST',
            url:'enter/save',
            data:$("form").serialize(),
            success:function(data){
                if(data.status==1){
                    $('#form1')[0].reset(); //重置
                    removeImg(1);
                    removeImg(2);
                    removeImg(3);
                    alert('报名成功');
                } else {
                    alert('保存失败：'+data.msg);
                }
            },
            error:function(html){
                var flag = (typeof console != 'undefined');
                if(flag) console.log("服务器忙，提交数据失败，代码:" +html.status+ "，请联系管理员！");
                alert("服务器忙，提交数据失败，请联系管理员！");
            }
        });
    }
    
    function validThisForm() {
        var imageId1 = $('#imageId1').val();
        var imageId2 = $('#imageId2').val();
        var imageId3 = $('#imageId3').val();
        var name= $('input[name="model.name"]').val();
        var phone= $('input[name="model.phone"]').val();
        var address= $('input[name="model.address"]').val();
        var alertStr = "";
        if($.trim(name).length==0){
            alertStr+="姓名不能为空\r\n";
        }
        if($.trim(imageId1).length==0&&$.trim(imageId2).length==0&&$.trim(imageId3).length==0){
            alertStr+="作品不能为空\r\n";
        }
        if($.trim(address).length==0){
            alertStr+="地址不能为空\r\n";
        }
        if($.trim(phone).length==0||!checkMobile($.trim(phone))){
            alertStr+="电话号码错误\r\n";
        }
        if(alertStr.length>0){
            alert(alertStr);
            return false;
        }
        return true;
    }

    function checkMobile(str) {
        var re = /^1\d{10}$/
        if (re.test(str)) {
            return true;
        } else {
            return false;
        }
    }

</script>
<script type="text/javascript" src="static/common/valid.js"></script>
<script type="text/javascript" src="static/component/ueditor/third-party/jquery-1.10.2.min.js"></script>
</body>
</html>